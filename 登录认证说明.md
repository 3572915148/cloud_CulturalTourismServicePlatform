# ç™»å½•è®¤è¯æœºåˆ¶è¯´æ˜

## ğŸ“‹ è®¾è®¡ç†å¿µ

### ç”¨æˆ·å‹å¥½çš„è®¿é—®æ§åˆ¶

**æ ¸å¿ƒåŸåˆ™ï¼š**
- âœ… è®¿å®¢å¯ä»¥è‡ªç”±æµè§ˆé¡µé¢å†…å®¹
- âœ… ä½¿ç”¨æŸäº›åŠŸèƒ½æ—¶æ‰éœ€è¦ç™»å½•
- âœ… æœªç™»å½•æ—¶ï¼Œè‡ªåŠ¨æç¤ºå¹¶è·³è½¬åˆ°ç™»å½•é¡µ

---

## ğŸ¯ æ¥å£æƒé™åˆ†ç±»

### 1ï¸âƒ£ **æ— éœ€ç™»å½•çš„æ¥å£**ï¼ˆæ‰€æœ‰äººå¯è®¿é—®ï¼‰

#### ç”¨æˆ·ç›¸å…³
- `POST /api/user/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/user/login` - ç”¨æˆ·ç™»å½•  
- `GET /api/user/{id}` - æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯

#### äº§å“ç›¸å…³
- `GET /api/product/list` - äº§å“åˆ—è¡¨
- `GET /api/product/{id}` - äº§å“è¯¦æƒ…
- `POST /api/product` - åˆ›å»ºäº§å“ï¼ˆå•†æˆ·åŠŸèƒ½ï¼‰
- `PUT /api/product` - æ›´æ–°äº§å“ï¼ˆå•†æˆ·åŠŸèƒ½ï¼‰
- `DELETE /api/product/{id}` - åˆ é™¤äº§å“ï¼ˆå•†æˆ·åŠŸèƒ½ï¼‰

#### è¯„ä»·ç›¸å…³
- `GET /api/review/product/{productId}` - æŸ¥çœ‹äº§å“è¯„ä»·

#### é™¶ç“·æ–‡åŒ–
- `GET /api/ceramic/**` - é™¶ç“·æ–‡åŒ–å†…å®¹

---

### 2ï¸âƒ£ **éœ€è¦ç™»å½•çš„æ¥å£**ï¼ˆå¿…é¡»æºå¸¦ Tokenï¼‰

#### ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- `GET /api/user/info` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ â­
- `PUT /api/user/update` - æ›´æ–°ä¸ªäººä¿¡æ¯ â­
- `PUT /api/user/password` - ä¿®æ”¹å¯†ç  â­
- `DELETE /api/user/delete` - æ³¨é”€è´¦å· â­

#### è®¢å•ç®¡ç†
- `POST /api/order/create` - åˆ›å»ºè®¢å• â­
- `POST /api/order/pay/{orderId}` - æ”¯ä»˜è®¢å• â­
- `GET /api/order/{orderId}` - æŸ¥çœ‹è®¢å•è¯¦æƒ… â­
- `GET /api/order/my` - æˆ‘çš„è®¢å•åˆ—è¡¨ â­
- `POST /api/order/cancel/{orderId}` - å–æ¶ˆè®¢å• â­
- `POST /api/order/finish/{orderId}` - å®Œæˆè®¢å• â­

#### è¯„ä»·ç®¡ç†
- `POST /api/review/create` - åˆ›å»ºè¯„ä»· â­
- `GET /api/review/my` - æˆ‘çš„è¯„ä»·åˆ—è¡¨ â­
- `DELETE /api/review/{reviewId}` - åˆ é™¤è¯„ä»· â­

#### åé¦ˆç®¡ç†
- `POST /api/feedback/create` - æäº¤åé¦ˆ â­
- `GET /api/feedback/my` - æˆ‘çš„åé¦ˆåˆ—è¡¨ â­
- `GET /api/feedback/{feedbackId}` - åé¦ˆè¯¦æƒ… â­
- `DELETE /api/feedback/{feedbackId}` - åˆ é™¤åé¦ˆ â­

---

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯å®ç°

#### 1. TokenUtil å·¥å…·ç±»

```java
@Component
@RequiredArgsConstructor
public class TokenUtil {
    private final JwtUtil jwtUtil;

    /**
     * ä»è¯·æ±‚å¤´ä¸­è·å–å¹¶éªŒè¯Tokenï¼Œè¿”å›ç”¨æˆ·ID
     * å¦‚æœTokenæ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºBusinessException
     */
    public Long getUserIdFromAuth(String authHeader) {
        if (!StringUtils.hasText(authHeader)) {
            throw new BusinessException("æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•");
        }

        String token = authHeader.startsWith("Bearer ") 
            ? authHeader.substring(7) 
            : authHeader;

        if (!jwtUtil.validateToken(token)) {
            throw new BusinessException("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        }

        return jwtUtil.getUserIdFromToken(token);
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç»Ÿä¸€çš„ Token éªŒè¯é€»è¾‘
- âœ… ç»Ÿä¸€çš„é”™è¯¯æç¤º
- âœ… ä»£ç å¤ç”¨ï¼Œå‡å°‘é‡å¤
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

#### 2. Controller ä½¿ç”¨ç¤ºä¾‹

```java
@RestController
@RequestMapping("/order")
@RequiredArgsConstructor
public class OrdersController {

    private final OrdersService ordersService;
    private final TokenUtil tokenUtil;

    /**
     * è·å–æˆ‘çš„è®¢å•åˆ—è¡¨
     * éœ€è¦ç™»å½•
     */
    @GetMapping("/my")
    public Result<Page<OrderVO>> getMyOrders(
            @RequestParam(defaultValue = "1") Long current,
            @RequestParam(defaultValue = "10") Long size,
            @RequestParam(required = false) Integer status,
            @RequestHeader("Authorization") String authHeader) {
        
        // éªŒè¯Tokenå¹¶è·å–ç”¨æˆ·ID
        Long userId = tokenUtil.getUserIdFromAuth(authHeader);
        
        // æŸ¥è¯¢ç”¨æˆ·è®¢å•
        Page<OrderVO> page = ordersService.getUserOrders(userId, current, size, status);
        return Result.success(page);
    }
}
```

**ç‰¹ç‚¹ï¼š**
- âœ… ä»£ç ç®€æ´
- âœ… è‡ªåŠ¨å¤„ç† Token éªŒè¯
- âœ… Token æ— æ•ˆæ—¶è‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸
- âœ… å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·å¹¶è¿”å›ç»Ÿä¸€æ ¼å¼

---

### å‰ç«¯å®ç°

#### 1. è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨æ·»åŠ  Tokenï¼‰

```javascript
// frontend/src/utils/request.js
request.interceptors.request.use(
  config => {
    // ä»localStorageè·å–token
    const token = localStorage.getItem('token')
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`
    }
    return config
  }
)
```

**æ•ˆæœï¼š**
- âœ… æ‰€æœ‰è¯·æ±‚è‡ªåŠ¨æºå¸¦ Token
- âœ… æ— éœ€åœ¨æ¯ä¸ª API è°ƒç”¨æ—¶æ‰‹åŠ¨æ·»åŠ 
- âœ… ç»Ÿä¸€ç®¡ç† Token

#### 2. å“åº”æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨å¤„ç†æœªç™»å½•ï¼‰

```javascript
request.interceptors.response.use(
  response => {
    const res = response.data
    
    if (res.code !== 200) {
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç™»å½•ç›¸å…³é”™è¯¯
      const loginErrorMessages = [
        'æœªç™»å½•', 'ç™»å½•å·²è¿‡æœŸ', 'Tokenè§£æå¤±è´¥', 
        'è¯·å…ˆç™»å½•', 'è¯·é‡æ–°ç™»å½•'
      ]
      
      const needLogin = res.code === 401 || 
        loginErrorMessages.some(msg => res.message?.includes(msg))
      
      if (needLogin) {
        ElMessage.error(res.message || 'è¯·é‡æ–°ç™»å½•')
        // æ¸…é™¤æœ¬åœ°Token
        localStorage.removeItem('token')
        localStorage.removeItem('userInfo')
        // è·³è½¬åˆ°ç™»å½•é¡µ
        router.push('/login')
      } else {
        ElMessage.error(res.message || 'è¯·æ±‚å¤±è´¥')
      }
    }
    
    return res
  }
)
```

**æ•ˆæœï¼š**
- âœ… è‡ªåŠ¨è¯†åˆ«ç™»å½•ç›¸å…³é”™è¯¯
- âœ… è‡ªåŠ¨æ¸…é™¤è¿‡æœŸçš„ Token
- âœ… è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
- âœ… æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

---

## ğŸ”„ å®Œæ•´çš„ç™»å½•æµç¨‹

### 1. ç”¨æˆ·ç™»å½•

```mermaid
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
    â†“
POST /api/user/login
    â†“
åç«¯éªŒè¯è´¦å·å¯†ç 
    â†“
ç”Ÿæˆ JWT Token
    â†“
è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯
    â†“
å‰ç«¯å­˜å‚¨åˆ° localStorage
    â†“
åç»­è¯·æ±‚è‡ªåŠ¨æºå¸¦ Token
```

**å‰ç«¯ä»£ç ï¼š**
```javascript
// ç™»å½•
const login = async () => {
  const response = await loginApi({
    username: loginForm.username,
    password: loginForm.password
  })
  
  // ä¿å­˜Tokenå’Œç”¨æˆ·ä¿¡æ¯
  localStorage.setItem('token', response.data.token)
  localStorage.setItem('userInfo', JSON.stringify(response.data))
  
  // è·³è½¬åˆ°é¦–é¡µ
  router.push('/home')
}
```

---

### 2. è®¿é—®éœ€è¦ç™»å½•çš„æ¥å£

```mermaid
ç”¨æˆ·ç‚¹å‡»"æˆ‘çš„è®¢å•"
    â†“
å‰ç«¯è°ƒç”¨ /api/order/my
    â†“
è¯·æ±‚æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ  Token
    â†“
GET /api/order/my
Header: Authorization: Bearer xxx
    â†“
åç«¯ TokenUtil éªŒè¯ Token
    â†“
ã€Tokenæœ‰æ•ˆã€‘
    â†“
è·å–ç”¨æˆ·ID
    â†“
æŸ¥è¯¢è®¢å•åˆ—è¡¨
    â†“
è¿”å›æ•°æ®
```

---

### 3. Token æ— æ•ˆæˆ–è¿‡æœŸ

```mermaid
ç”¨æˆ·è®¿é—®éœ€è¦ç™»å½•çš„æ¥å£
    â†“
Token æ— æ•ˆæˆ–ä¸å­˜åœ¨
    â†“
TokenUtil æŠ›å‡ºå¼‚å¸¸
"æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•"
    â†“
å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·
    â†“
è¿”å› { code: 400, message: "æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•" }
    â†“
å‰ç«¯å“åº”æ‹¦æˆªå™¨æ£€æµ‹åˆ°ç™»å½•é”™è¯¯
    â†“
æ¸…é™¤ localStorage
    â†“
æç¤º"æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•"
    â†“
è·³è½¬åˆ°ç™»å½•é¡µ
```

---

## ğŸ“Š ä¸åŒåœºæ™¯çš„å¤„ç†

### åœºæ™¯ 1ï¼šè®¿å®¢æµè§ˆäº§å“

```
è®¿å®¢æ‰“å¼€ç½‘ç«™
    â†“
è®¿é—®é¦–é¡µ âœ… æ— éœ€ç™»å½•
    â†“
æµè§ˆäº§å“åˆ—è¡¨ âœ… æ— éœ€ç™»å½•
    â†“
æŸ¥çœ‹äº§å“è¯¦æƒ… âœ… æ— éœ€ç™»å½•
    â†“
æŸ¥çœ‹äº§å“è¯„ä»· âœ… æ— éœ€ç™»å½•
```

**ç”¨æˆ·ä½“éªŒï¼š**
- âœ… æµç•…æµè§ˆï¼Œæ— éœ€æ³¨å†Œå³å¯æŸ¥çœ‹å†…å®¹
- âœ… é™ä½ä½¿ç”¨é—¨æ§›ï¼Œå¸å¼•æ›´å¤šç”¨æˆ·

---

### åœºæ™¯ 2ï¼šç”¨æˆ·ä¸‹å•

```
ç”¨æˆ·æµè§ˆäº§å“
    â†“
ç‚¹å‡»"ç«‹å³è´­ä¹°"
    â†“
æ£€æŸ¥æ˜¯å¦ç™»å½•
    â†“
ã€æœªç™»å½•ã€‘
    â†“
æç¤º"è¯·å…ˆç™»å½•"
    â†“
è·³è½¬åˆ°ç™»å½•é¡µ
    â†“
ç”¨æˆ·ç™»å½•æˆåŠŸ
    â†“
è·³è½¬å›äº§å“è¯¦æƒ…é¡µ
    â†“
åˆ›å»ºè®¢å• âœ… å·²ç™»å½•
```

**ç”¨æˆ·ä½“éªŒï¼š**
- âœ… åªåœ¨å¿…è¦æ—¶æ‰è¦æ±‚ç™»å½•
- âœ… ç™»å½•åå¯ä»¥ç»§ç»­ä¹‹å‰çš„æ“ä½œ
- âœ… æµç¨‹é¡ºç•…ï¼Œä¸æ‰“æ–­ç”¨æˆ·

---

### åœºæ™¯ 3ï¼šToken è¿‡æœŸ

```
ç”¨æˆ·å·²ç™»å½•
    â†“
Token 7å¤©åè¿‡æœŸ
    â†“
è®¿é—®"æˆ‘çš„è®¢å•"
    â†“
åç«¯éªŒè¯Token â†’ å·²è¿‡æœŸ
    â†“
è¿”å›"ç™»å½•å·²è¿‡æœŸ"
    â†“
å‰ç«¯è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
    â†“
ç”¨æˆ·é‡æ–°ç™»å½•
    â†“
ç»§ç»­ä½¿ç”¨ âœ…
```

**ç”¨æˆ·ä½“éªŒï¼š**
- âœ… è‡ªåŠ¨æ£€æµ‹ Token è¿‡æœŸ
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… æ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. Token å®‰å…¨

- âœ… **JWT åŠ å¯†å­˜å‚¨**ï¼šä½¿ç”¨å¼ºå¯†é’¥åŠ å¯†
- âœ… **æœ‰æ•ˆæœŸé™åˆ¶**ï¼šToken 7å¤©åè‡ªåŠ¨è¿‡æœŸ
- âœ… **è¯·æ±‚å¤´ä¼ è¾“**ï¼šä¸åœ¨ URL ä¸­æš´éœ²Token
- âœ… **Bearer æ ¼å¼**ï¼šæ ‡å‡†çš„è®¤è¯å¤´æ ¼å¼

### 2. å¯†ç å®‰å…¨

- âœ… **BCrypt åŠ å¯†**ï¼šä¸å¯é€†åŠ å¯†ç®—æ³•
- âœ… **å¯†ç é•¿åº¦é™åˆ¶**ï¼š6-20ä½
- âœ… **å¯†ç éªŒè¯**ï¼šä¿®æ”¹å¯†ç éœ€éªŒè¯åŸå¯†ç 

### 3. æ¥å£å®‰å…¨

- âœ… **ç»Ÿä¸€éªŒè¯**ï¼šæ‰€æœ‰éœ€è¦ç™»å½•çš„æ¥å£éƒ½ç»è¿‡éªŒè¯
- âœ… **æƒé™éš”ç¦»**ï¼šç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
- âœ… **æ•°æ®éªŒè¯**ï¼šå‰åç«¯åŒé‡æ•°æ®éªŒè¯

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### å‰ç«¯å¼€å‘

#### 1. API è°ƒç”¨

```javascript
// âœ… å¥½çš„åšæ³•ï¼šæ— éœ€æ‰‹åŠ¨æ·»åŠ Tokenï¼Œæ‹¦æˆªå™¨ä¼šè‡ªåŠ¨å¤„ç†
import { getMyOrders } from '@/api/order'

const fetchOrders = async () => {
  try {
    const response = await getMyOrders({ current: 1, size: 10 })
    orders.value = response.data
  } catch (error) {
    // æ‹¦æˆªå™¨å·²ç»å¤„ç†äº†æœªç™»å½•çš„æƒ…å†µ
    console.error('è·å–è®¢å•å¤±è´¥ï¼š', error)
  }
}
```

```javascript
// âŒ ä¸å¥½çš„åšæ³•ï¼šä¸è¦æ‰‹åŠ¨æ·»åŠ Token
const response = await axios.get('/api/order/my', {
  headers: {
    'Authorization': `Bearer ${token}`  // ä¸éœ€è¦ï¼
  }
})
```

#### 2. è·¯ç”±å®ˆå«

```javascript
// router/index.js
router.beforeEach((to, from, next) => {
  // æ£€æŸ¥è·¯ç”±æ˜¯å¦éœ€è¦ç™»å½•
  if (to.meta.requireAuth) {
    const token = localStorage.getItem('token')
    if (!token) {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      next({
        path: '/login',
        query: { redirect: to.fullPath }  // è®°å½•åŸå§‹é¡µé¢
      })
      return
    }
  }
  next()
})
```

---

### åç«¯å¼€å‘

#### 1. æ–°å¢éœ€è¦ç™»å½•çš„æ¥å£

```java
@GetMapping("/my-data")
public Result<DataVO> getMyData(@RequestHeader("Authorization") String authHeader) {
    // 1. éªŒè¯Tokenå¹¶è·å–ç”¨æˆ·ID
    Long userId = tokenUtil.getUserIdFromAuth(authHeader);
    
    // 2. æŸ¥è¯¢ç”¨æˆ·æ•°æ®
    DataVO data = dataService.getByUserId(userId);
    
    // 3. è¿”å›ç»“æœ
    return Result.success(data);
}
```

#### 2. å¯é€‰ç™»å½•çš„æ¥å£

```java
@GetMapping("/data/{id}")
public Result<DataVO> getData(
        @PathVariable Long id,
        @RequestHeader(value = "Authorization", required = false) String authHeader) {
    
    // è·å–ç”¨æˆ·IDï¼ˆå¯èƒ½ä¸ºnullï¼‰
    Long userId = tokenUtil.getUserIdFromAuthOptional(authHeader);
    
    // æ ¹æ®æ˜¯å¦ç™»å½•è¿”å›ä¸åŒçš„æ•°æ®
    DataVO data = dataService.getById(id, userId);
    
    return Result.success(data);
}
```

---

## ğŸ‰ æ€»ç»“

### ä¼˜ç‚¹

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| **ç”¨æˆ·å‹å¥½** | è®¿å®¢å¯ä»¥è‡ªç”±æµè§ˆï¼Œé™ä½ä½¿ç”¨é—¨æ§› |
| **å®‰å…¨å¯é ** | Token éªŒè¯ã€å¯†ç åŠ å¯†ã€æƒé™æ§åˆ¶ |
| **è‡ªåŠ¨å¤„ç†** | å‰ç«¯è‡ªåŠ¨æ·»åŠ Tokenï¼Œè‡ªåŠ¨å¤„ç†è¿‡æœŸ |
| **ä»£ç ç®€æ´** | ç»Ÿä¸€çš„éªŒè¯å·¥å…·ï¼Œå‡å°‘é‡å¤ä»£ç  |
| **æ˜“äºç»´æŠ¤** | é›†ä¸­ç®¡ç†ï¼Œä¾¿äºä¿®æ”¹å’Œæ‰©å±• |
| **ä½“éªŒæµç•…** | è‡ªåŠ¨è·³è½¬ï¼Œå‹å¥½æç¤ºï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–° |

### æ ¸å¿ƒæµç¨‹

```
1. ç™»å½• â†’ è·å–Token â†’ å­˜å‚¨æœ¬åœ°
2. è®¿é—®æ¥å£ â†’ è‡ªåŠ¨æºå¸¦Token â†’ éªŒè¯é€šè¿‡ â†’ è¿”å›æ•°æ®
3. Tokenè¿‡æœŸ â†’ è‡ªåŠ¨æ£€æµ‹ â†’ æ¸…é™¤æœ¬åœ° â†’ è·³è½¬ç™»å½•
```

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025-10-14  
**çŠ¶æ€**: âœ… å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡

